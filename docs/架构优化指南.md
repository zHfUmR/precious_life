# æ¶æ„ä¼˜åŒ–æŒ‡å— ğŸ—ï¸

è¿™ä»½æŒ‡å—å°†å¸®åŠ©ä½ å°†ç°æœ‰é¡¹ç›®å‡çº§ä¸ºæ›´ä¼˜ç§€çš„æ¶æ„ï¼Œå¼•å…¥æ•°æ®åº“æ”¯æŒï¼Œå¹¶æ”¹å–„ä»£ç ç»„ç»‡ç»“æ„ã€‚

## ğŸ¯ ä¼˜åŒ–ç›®æ ‡

1. **æ¸…æ™°çš„æ•°æ®å±‚æ¶æ„**ï¼šå¼•å…¥Repositoryæ¨¡å¼ï¼Œç»Ÿä¸€æ•°æ®è®¿é—®
2. **æ•°æ®åº“æ”¯æŒ**ï¼šä½¿ç”¨Drift ORMæä¾›ç±»å‹å®‰å…¨çš„æ•°æ®åº“æ“ä½œ
3. **æ›´å¥½çš„ä»£ç ç»„ç»‡**ï¼šæ¨¡å—åŒ–è®¾è®¡ï¼Œé™ä½è€¦åˆåº¦
4. **ç¼“å­˜ç­–ç•¥ä¼˜åŒ–**ï¼šå¤šçº§ç¼“å­˜æé«˜æ€§èƒ½
5. **é”™è¯¯å¤„ç†æ”¹è¿›**ï¼šç»Ÿä¸€çš„å¼‚å¸¸å¤„ç†æœºåˆ¶

## ğŸ“‹ å½“å‰æ¶æ„é—®é¢˜åˆ†æ

### 1. æ•°æ®è®¿é—®æ··ä¹±
```dart
// âŒ å½“å‰ä»£ç ï¼šç›´æ¥åœ¨ViewModelä¸­æ“ä½œå­˜å‚¨
class WeatherCardVm extends Notifier<WeatherCardState> {
  Future<void> addFollowedPoint(FollowedPoint point) async {
    // ç›´æ¥æ“ä½œSharedPreferences
    final newPointsJson = jsonEncode(pointsToStore);
    await CPSP.instance.setString(StorageKeys.followedWeatherPoints, newPointsJson);
  }
}
```

### 2. ç¼ºå°‘ç»Ÿä¸€çš„é”™è¯¯å¤„ç†
```dart
// âŒ å½“å‰ä»£ç ï¼šé”™è¯¯å¤„ç†åˆ†æ•£ä¸”ä¸ä¸€è‡´
try {
  final weatherResponse = await QweatherApiService.getNowWeather(point.locationStr);
} catch (e) {
  // ä¸åŒåœ°æ–¹æœ‰ä¸åŒçš„é”™è¯¯å¤„ç†é€»è¾‘
}
```

### 3. æ²¡æœ‰æ•°æ®ç¼“å­˜ç­–ç•¥
- æ¯æ¬¡éƒ½éœ€è¦ç½‘ç»œè¯·æ±‚
- æ²¡æœ‰ç¦»çº¿æ•°æ®æ”¯æŒ
- é‡å¤æ•°æ®è·å–

## ğŸš€ æ–°æ¶æ„è®¾è®¡

### æ•°æ®å±‚æ¶æ„å›¾
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   UI Layer      â”‚ â† Riverpod Providers
â”‚                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Repository Layerâ”‚ â† ç»Ÿä¸€æ•°æ®è®¿é—®æ¥å£
â”‚                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ DataSource Layerâ”‚ â† å…·ä½“æ•°æ®è·å–å®ç°
â”‚ â”œâ”€ Local        â”‚   â”œâ”€ Database (Drift)
â”‚ â”œâ”€ Remote       â”‚   â”œâ”€ SharedPreferences  
â”‚ â””â”€ Cache        â”‚   â””â”€ API Clients
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### å­˜å‚¨ç­–ç•¥åˆ†å±‚
```
å†…å­˜ç¼“å­˜ (æœ€å¿«)
    â†“
æœ¬åœ°æ•°æ®åº“ (ä¸­ç­‰é€Ÿåº¦ï¼ŒæŒä¹…åŒ–)
    â†“
SharedPreferences (ç®€å•é…ç½®)
    â†“
è¿œç¨‹API (æœ€æ…¢ï¼Œä½†æ•°æ®æœ€æ–°)
```

## ğŸ“ è¿ç§»æ­¥éª¤

### ç¬¬ä¸€æ­¥ï¼šé…ç½®æ•°æ®åº“ä¾èµ–

1. **æ›´æ–° `pubspec.yaml`**
```yaml
dependencies:
  # ç°æœ‰ä¾èµ–ä¿æŒä¸å˜...
  
  # æ·»åŠ æ•°æ®åº“æ”¯æŒ
  sqflite: ^2.3.0
  drift: ^2.14.0
  sqlite3_flutter_libs: ^0.5.0
  path_provider: ^2.1.0
  path: ^1.8.3

dev_dependencies:
  # ç°æœ‰ä¾èµ–ä¿æŒä¸å˜...
  
  # æ·»åŠ ä»£ç ç”Ÿæˆ
  drift_dev: ^2.14.0
```

2. **è¿è¡Œä¾èµ–å®‰è£…**
```bash
flutter pub get
```

### ç¬¬äºŒæ­¥ï¼šåˆ›å»ºRepositoryå±‚

**ä¼˜åŒ–å‰çš„ä»£ç **ï¼š
```dart
// âŒ åœ¨ViewModelä¸­ç›´æ¥æ“ä½œå­˜å‚¨
class WeatherCardVm extends Notifier<WeatherCardState> {
  Future<void> loadFollowedWeather() async {
    // ç›´æ¥è¯»å–SharedPreferences
    final followedPointsJson = await CPSP.instance.getString(StorageKeys.followedWeatherPoints);
    // ç›´æ¥è°ƒç”¨API
    final weatherResponse = await QweatherApiService.getNowWeather(point.locationStr);
  }
}
```

**ä¼˜åŒ–åçš„ä»£ç **ï¼š
```dart
// âœ… ä½¿ç”¨Repositoryç»Ÿä¸€æ•°æ®è®¿é—®
class WeatherCardVm extends Notifier<WeatherCardState> {
  late final WeatherRepository _weatherRepository;
  
  @override
  WeatherCardState build() {
    _weatherRepository = ref.read(weatherRepositoryProvider);
    return const WeatherCardState.initial();
  }
  
  Future<void> loadFollowedWeather() async {
    try {
      // é€šè¿‡Repositoryè·å–æ•°æ®ï¼Œè‡ªåŠ¨å¤„ç†ç¼“å­˜
      final weatherData = await _weatherRepository.getWeatherData(locationStr);
      state = state.copyWith(weatherData: weatherData);
    } catch (e) {
      state = state.copyWith(error: e.toString());
    }
  }
}
```

### ç¬¬ä¸‰æ­¥ï¼šä¼˜åŒ–ç°æœ‰WeatherCardVm

**åˆ›å»ºæ–°çš„WeatherCardVm**ï¼š
```dart
// lib/features/todo/ui/providers/weather_card_vm_v2.dart
import 'package:flutter_riverpod/flutter_riverpod.dart';
import 'package:precious_life/data/repositories/weather_repository.dart';
import 'package:precious_life/data/providers/repository_providers.dart';

@riverpod
class WeatherCardVmV2 extends _$WeatherCardVmV2 {
  late final WeatherRepository _weatherRepository;
  
  @override
  WeatherCardState build() {
    _weatherRepository = ref.read(weatherRepositoryProvider);
    return const WeatherCardState.initial();
  }
  
  /// åŠ è½½å…³æ³¨çš„å¤©æ°”ç‚¹ï¼ˆå¸¦ç¼“å­˜ä¼˜åŒ–ï¼‰
  Future<void> loadFollowedWeather({bool forceRefresh = false}) async {
    state = state.copyWith(weatherFollowedState: 
      const WeatherCardFollowedState(loadingStatus: LoadingStatus.loading));
    
    try {
      // ä»æœ¬åœ°å­˜å‚¨è·å–å…³æ³¨ç‚¹åˆ—è¡¨
      final followedPoints = await _getFollowedPoints();
      
      if (followedPoints.isEmpty) {
        state = state.copyWith(
          weatherFollowedState: const WeatherCardFollowedState(
            loadingStatus: LoadingStatus.success, 
            followedWeather: []));
        return;
      }
      
      // ä½¿ç”¨Repositoryæ‰¹é‡è·å–å¤©æ°”æ•°æ®
      final locations = followedPoints.map((p) => p.locationStr).toList();
      final weatherDataMap = await _weatherRepository.getBatchWeatherData(
        locations, 
        maxConcurrency: 3
      );
      
      // æ„å»ºç»“æœ
      final weatherResults = followedPoints.map((point) {
        final weatherData = weatherDataMap[point.locationStr];
        return WeatherCardFollowedWeather(
          point: point,
          loadingStatus: weatherData != null 
            ? LoadingStatus.success 
            : LoadingStatus.failure,
          weather: weatherData?.now,
          errorMessage: weatherData == null ? 'è·å–å¤©æ°”æ•°æ®å¤±è´¥' : null,
        );
      }).toList();
      
      state = state.copyWith(
        weatherFollowedState: WeatherCardFollowedState(
          loadingStatus: LoadingStatus.success,
          followedWeather: weatherResults));
          
    } catch (e) {
      state = state.copyWith(
        weatherFollowedState: WeatherCardFollowedState(
          loadingStatus: LoadingStatus.failure,
          errorMessage: e.toString()));
    }
  }
  
  /// é¢„åŠ è½½å¤©æ°”æ•°æ®ï¼ˆåå°é™é»˜è·å–ï¼‰
  Future<void> preloadWeatherData() async {
    try {
      final followedPoints = await _getFollowedPoints();
      final locations = followedPoints.map((p) => p.locationStr).toList();
      await _weatherRepository.preloadWeatherData(locations);
    } catch (e) {
      // é¢„åŠ è½½å¤±è´¥ä¸å½±å“ä¸»æµç¨‹
    }
  }
}
```

### ç¬¬å››æ­¥ï¼šæ¸è¿›å¼è¿ç§»

1. **ä¿ç•™ç°æœ‰ä»£ç **ï¼šæš‚æ—¶ä¿ç•™ `weather_card_vm.dart`
2. **åˆ›å»ºæ–°ç‰ˆæœ¬**ï¼šåˆ›å»º `weather_card_vm_v2.dart` ä½¿ç”¨æ–°æ¶æ„
3. **A/Bæµ‹è¯•**ï¼šåœ¨ä¸åŒé¡µé¢ä½¿ç”¨ä¸åŒç‰ˆæœ¬
4. **é€æ­¥è¿ç§»**ï¼šç¡®è®¤æ–°ç‰ˆæœ¬ç¨³å®šåæ›¿æ¢æ—§ç‰ˆæœ¬

### ç¬¬äº”æ­¥ï¼šæ•°æ®åº“è¿ç§»

**å½“å‰å­˜å‚¨æ–¹å¼**ï¼š
```dart
// âŒ æ‰€æœ‰æ•°æ®éƒ½å­˜åœ¨SharedPreferencesä¸­
await CPSP.instance.setString(StorageKeys.followedWeatherPoints, newPointsJson);
```

**ä¼˜åŒ–åçš„å­˜å‚¨ç­–ç•¥**ï¼š
```dart
// âœ… æ ¹æ®æ•°æ®ç±»å‹é€‰æ‹©å­˜å‚¨æ–¹å¼
class DataStorageStrategy {
  // ç®€å•é…ç½® â†’ SharedPreferences
  static Future<void> saveApiKey(String key) async {
    await StorageDataSourceFactory.getSettingsStorage().saveString('api_key', key);
  }
  
  // ç»“æ„åŒ–æ•°æ® â†’ SQLiteæ•°æ®åº“
  static Future<void> saveFollowedPoints(List<FollowedPoint> points) async {
    await database.todoDao.saveFollowedPoints(points);
  }
  
  // ç¼“å­˜æ•°æ® â†’ å†…å­˜ + æ•°æ®åº“åŒé‡ç¼“å­˜
  static Future<void> cacheWeatherData(String location, WeatherData data) async {
    await weatherRepository.cacheWeatherData(location, data);
  }
}
```

## ğŸ”§ å®æ–½å»ºè®®

### ä¼˜å…ˆçº§æ’åº

**é«˜ä¼˜å…ˆçº§ï¼ˆç«‹å³å®æ–½ï¼‰**ï¼š
1. âœ… åˆ›å»ºRepositoryå±‚
2. âœ… é‡æ„WeatherCardVmä½¿ç”¨Repository
3. âœ… ä¼˜åŒ–é”™è¯¯å¤„ç†

**ä¸­ä¼˜å…ˆçº§ï¼ˆä¸€ä¸ªæœˆå†…ï¼‰**ï¼š
4. å®Œæˆæ•°æ®åº“é…ç½®
5. å®ç°æ•°æ®è¿ç§»å·¥å…·
6. æ·»åŠ ç¦»çº¿æ”¯æŒ

**ä½ä¼˜å…ˆçº§ï¼ˆé•¿æœŸä¼˜åŒ–ï¼‰**ï¼š
7. æ·»åŠ æ•°æ®åŒæ­¥æœºåˆ¶
8. å®ç°æ›´å¤æ‚çš„ç¼“å­˜ç­–ç•¥
9. æ·»åŠ æ€§èƒ½ç›‘æ§

### é£é™©æ§åˆ¶

1. **æ¸è¿›å¼è¿ç§»**ï¼šä¸è¦ä¸€æ¬¡æ€§æ›¿æ¢æ‰€æœ‰ä»£ç 
2. **ä¿ç•™å¤‡ä»½**ï¼šä¿ç•™ç°æœ‰ä»£ç ä½œä¸ºfallback
3. **å……åˆ†æµ‹è¯•**ï¼šæ¯ä¸ªæ­¥éª¤éƒ½è¦æµ‹è¯•åŠŸèƒ½å®Œæ•´æ€§
4. **æ€§èƒ½ç›‘æ§**ï¼šå…³æ³¨è¿ç§»åçš„æ€§èƒ½å˜åŒ–

## ğŸ“Š é¢„æœŸæ”¶ç›Š

### ä»£ç è´¨é‡æå‡
- **å¯æµ‹è¯•æ€§**ï¼šRepositoryå±‚æ˜“äºmockå’Œæµ‹è¯•
- **å¯ç»´æŠ¤æ€§**ï¼šæ¸…æ™°çš„åˆ†å±‚æ¶æ„
- **å¯æ‰©å±•æ€§**ï¼šæ–°å¢æ•°æ®æºæˆ–å­˜å‚¨æ–¹å¼å®¹æ˜“

### æ€§èƒ½ä¼˜åŒ–
- **ç¼“å­˜ç­–ç•¥**ï¼šå¤šçº§ç¼“å­˜å‡å°‘ç½‘ç»œè¯·æ±‚
- **æ‰¹é‡æ“ä½œ**ï¼šå‡å°‘æ•°æ®åº“è®¿é—®æ¬¡æ•°
- **ç¦»çº¿æ”¯æŒ**ï¼šæé«˜ç”¨æˆ·ä½“éªŒ

### å¼€å‘æ•ˆç‡
- **ç»Ÿä¸€æ¥å£**ï¼šå‡å°‘é‡å¤ä»£ç 
- **é”™è¯¯å¤„ç†**ï¼šç»Ÿä¸€çš„å¼‚å¸¸ç®¡ç†
- **ä¾èµ–æ³¨å…¥**ï¼šä¾¿äºå•å…ƒæµ‹è¯•å’Œæ¨¡å—åŒ–

## ğŸ‰ æ€»ç»“

è¿™ä¸ªæ¶æ„ä¼˜åŒ–æ–¹æ¡ˆæ—¢ä¿æŒäº†ç°æœ‰åŠŸèƒ½çš„ç¨³å®šæ€§ï¼Œåˆä¸ºæœªæ¥æ‰©å±•æ‰“ä¸‹äº†è‰¯å¥½åŸºç¡€ã€‚é€šè¿‡æ¸è¿›å¼è¿ç§»ï¼Œä½ å¯ä»¥ï¼š

1. ğŸ—ï¸ **å»ºç«‹æ¸…æ™°çš„æ•°æ®å±‚æ¶æ„**
2. ğŸ“± **å¼•å…¥ç°ä»£åŒ–çš„æ•°æ®åº“æ”¯æŒ**  
3. âš¡ **ä¼˜åŒ–æ€§èƒ½å’Œç”¨æˆ·ä½“éªŒ**
4. ğŸ”§ **æé«˜ä»£ç è´¨é‡å’Œå¯ç»´æŠ¤æ€§**

è®°ä½ï¼Œå¥½çš„æ¶æ„ä¸æ˜¯ä¸€è¹´è€Œå°±çš„ï¼Œè€Œæ˜¯åœ¨å®è·µä¸­ä¸æ–­ä¼˜åŒ–å’Œå®Œå–„çš„ç»“æœï¼(â—•â€¿â—•)â™¡ 