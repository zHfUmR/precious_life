# ğŸ¦„ ç½‘ç»œè¯·æ±‚æ¶æ„è®¾è®¡ï¼ˆå¤šAPIæœåŠ¡ï¼ŒDioå°è£…ï¼ŒApiClientå‡çº§ç‰ˆï¼‰

æœ¬è®¾è®¡é€‚ç”¨äºéœ€è¦å¯¹æ¥å¤šä¸ªä¸åŒç½‘ç«™APIçš„Flutter/Darté¡¹ç›®ï¼Œé‡‡ç”¨Dioè¿›è¡Œç½‘ç»œè¯·æ±‚å°è£…ï¼Œç»“æ„æ¸…æ™°ã€æ˜“æ‰©å±•ã€æ˜“ç»´æŠ¤ã€‚

---

## 1. æ¶æ„æ ¸å¿ƒæ€æƒ³

- **å¤šAPIæœåŠ¡æ”¯æŒ**ï¼šé€šè¿‡`ApiServiceType`æšä¸¾åŒºåˆ†ä¸åŒAPIæœåŠ¡ã€‚
- **ç»Ÿä¸€ApiClientç®¡ç†**ï¼š`NetworkManager`é›†ä¸­ç®¡ç†æ‰€æœ‰ApiClientå®ä¾‹ï¼Œæ¯ä¸ªApiClientå¯è‡ªå®šä¹‰baseUrlã€headersã€æ‹¦æˆªå™¨ã€è½¬æ¢å™¨ç­‰ã€‚
- **è¯·æ±‚/å“åº”æŠ½è±¡**ï¼šå®šä¹‰`ApiRequest`å’Œ`ApiResponse`åŸºç±»ï¼Œä¾¿äºç»Ÿä¸€å¤„ç†å’Œæ‰©å±•ã€‚
- **Serviceåˆ†å±‚**ï¼šæ¯ä¸ªAPIæœåŠ¡å•ç‹¬å†™Serviceç±»ï¼Œä¸“æ³¨ä¸šåŠ¡é€»è¾‘ã€‚
- **æ‹¦æˆªå™¨ä¸é€šç”¨é…ç½®**ï¼šå…¨å±€æ‹¦æˆªå™¨ç»Ÿä¸€é…ç½®ï¼Œç‰¹æ®Šéœ€æ±‚å¯å•ç‹¬å¤„ç†ã€‚
- **çµæ´»æ‹¦æˆªå™¨æœºåˆ¶**ï¼šæ”¯æŒæ—¥å¿—æ‰“å°ã€é‰´æƒã€é”™è¯¯å¤„ç†ç­‰å¤šç§æ‹¦æˆªå™¨ï¼Œå¯æŒ‰éœ€é…ç½®ã€‚

---

## 2. ç›®å½•ç»“æ„å»ºè®®

```
lib/
  network/
    api_service_type.dart      // APIæœåŠ¡ç±»å‹æšä¸¾
    api_client.dart            // ApiClienté…ç½®ç±»
    network_manager.dart       // ç»Ÿä¸€ç®¡ç†ApiClientå®ä¾‹
    interceptors.dart          // æ‹¦æˆªå™¨å®ç°
    api_request.dart           // è¯·æ±‚æŠ½è±¡åŸºç±»
    api_response.dart          // å“åº”æŠ½è±¡åŸºç±»
    services/
      main_service.dart        // ä¸»APIæœåŠ¡
      weather_service.dart     // å¤©æ°”APIæœåŠ¡
  models/
    user_info_response.dart    // ç”¨æˆ·ä¿¡æ¯å“åº”æ¨¡å‹
    ...
```

---

## 3. ä»£ç ç¤ºä¾‹

### 3.1 ApiServiceType æšä¸¾
```dart
// api_service_type.dart
/// APIæœåŠ¡ç±»å‹æšä¸¾ï¼Œç”¨äºåŒºåˆ†ä¸åŒçš„APIæœåŠ¡
enum ApiServiceType {
  main,      // ä¸»API
  weather,   // å¤©æ°”API
  auth,      // è®¤è¯API
}
```

### 3.2 ApiClient é…ç½®ç±»
```dart
// api_client.dart
import 'package:dio/dio.dart';

/// è¯·æ±‚è½¬æ¢å™¨ç±»å‹å®šä¹‰
typedef RequestTransformer = dynamic Function(dynamic data);

/// å“åº”è½¬æ¢å™¨ç±»å‹å®šä¹‰
typedef ResponseTransformer<T> = T Function(dynamic data);

/// ApiClient å°è£…äº†APIæœåŠ¡çš„æ‰€æœ‰é…ç½®
class ApiClient {
  /// åŸºç¡€URL
  final String baseUrl;
  /// è¯·æ±‚å¤´
  final Map<String, String> headers;
  /// è¯·æ±‚è½¬æ¢å™¨
  final RequestTransformer? requestTransformer;
  /// å“åº”è½¬æ¢å™¨
  final ResponseTransformer? responseTransformer;
  /// æ‹¦æˆªå™¨åˆ—è¡¨
  final List<Interceptor> interceptors;
  /// è¶…æ—¶æ—¶é—´ï¼ˆæ¯«ç§’ï¼‰
  final int connectTimeout;
  final int receiveTimeout;
  final int sendTimeout;

  ApiClient({
    required this.baseUrl,
    this.headers = const {},
    this.requestTransformer,
    this.responseTransformer,
    this.interceptors = const [],
    this.connectTimeout = 15000,
    this.receiveTimeout = 15000,
    this.sendTimeout = 15000,
  });

  /// è·å–é…ç½®å¥½çš„Dioå®ä¾‹
  Dio get dio {
    final dio = Dio(BaseOptions(
      baseUrl: baseUrl,
      headers: headers,
      connectTimeout: Duration(milliseconds: connectTimeout),
      receiveTimeout: Duration(milliseconds: receiveTimeout),
      sendTimeout: Duration(milliseconds: sendTimeout),
    ));
    
    // æ·»åŠ æ‹¦æˆªå™¨
    for (final i in interceptors) {
      dio.interceptors.add(i);
    }
    
    return dio;
  }
}
```

### 3.3 æ‹¦æˆªå™¨å®ç°
```dart
// interceptors.dart
import 'package:dio/dio.dart';

/// æ‹¦æˆªå™¨å·¥å‚ï¼Œæä¾›å„ç§å¸¸ç”¨æ‹¦æˆªå™¨å®ä¾‹
class InterceptorFactory {
  /// åˆ›å»ºæ—¥å¿—æ‹¦æˆªå™¨
  static LogInterceptor createLogInterceptor({
    bool requestBody = true,
    bool responseBody = true,
  }) {
    return LogInterceptor(
      requestHeader: true,
      requestBody: requestBody,
      responseHeader: true,
      responseBody: responseBody,
      logPrint: (log) {
        // å¯ä»¥æ›¿æ¢æˆè‡ªå·±çš„æ—¥å¿—æ‰“å°æ–¹å¼
        print('ğŸŒ HTTP: $log');
      }
    );
  }

  /// åˆ›å»ºé‰´æƒæ‹¦æˆªå™¨
  static AuthInterceptor createAuthInterceptor(
    String Function() tokenGetter,
  ) {
    return AuthInterceptor(tokenGetter);
  }
  
  /// åˆ›å»ºé”™è¯¯å¤„ç†æ‹¦æˆªå™¨
  static ErrorInterceptor createErrorInterceptor() {
    return ErrorInterceptor();
  }
}

/// é‰´æƒæ‹¦æˆªå™¨ï¼Œä¸ºè¯·æ±‚è‡ªåŠ¨æ·»åŠ Tokenç­‰è®¤è¯ä¿¡æ¯
class AuthInterceptor extends Interceptor {
  final String Function() _getToken;
  
  AuthInterceptor(this._getToken);
  
  @override
  void onRequest(RequestOptions options, RequestInterceptorHandler handler) {
    // è·å–token
    final token = _getToken();
    if (token.isNotEmpty) {
      // æ·»åŠ Authorizationå¤´
      options.headers['Authorization'] = 'Bearer $token';
    }
    return super.onRequest(options, handler);
  }
}

/// é”™è¯¯å¤„ç†æ‹¦æˆªå™¨ï¼Œç»Ÿä¸€å¤„ç†é”™è¯¯å“åº”
class ErrorInterceptor extends Interceptor {
  @override
  void onError(DioException err, ErrorInterceptorHandler handler) {
    // ç»Ÿä¸€å¤„ç†é”™è¯¯
    switch (err.type) {
      case DioExceptionType.connectionTimeout:
      case DioExceptionType.sendTimeout:
      case DioExceptionType.receiveTimeout:
        err = _handleTimeoutError(err);
        break;
      case DioExceptionType.badResponse:
        err = _handleResponseError(err);
        break;
      default:
        err = _handleDefaultError(err);
    }
    
    // ç»§ç»­ä¼ é€’é”™è¯¯
    return super.onError(err, handler);
  }
  
  /// å¤„ç†è¶…æ—¶é”™è¯¯
  DioException _handleTimeoutError(DioException err) {
    return err.copyWith(
      error: 'ç½‘ç»œè¿æ¥è¶…æ—¶ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè®¾ç½®',
    );
  }
  
  /// å¤„ç†æœåŠ¡å™¨å“åº”é”™è¯¯
  DioException _handleResponseError(DioException err) {
    final statusCode = err.response?.statusCode;
    
    if (statusCode == 401) {
      // å¤„ç†æœªæˆæƒé”™è¯¯
      return err.copyWith(
        error: 'ç™»å½•ä¿¡æ¯å·²è¿‡æœŸï¼Œè¯·é‡æ–°ç™»å½•',
      );
    } else if (statusCode == 403) {
      return err.copyWith(
        error: 'æ²¡æœ‰æƒé™è®¿é—®è¯¥èµ„æº',
      );
    } else if (statusCode == 404) {
      return err.copyWith(
        error: 'è¯·æ±‚çš„èµ„æºä¸å­˜åœ¨',
      );
    } else if (statusCode! >= 500) {
      return err.copyWith(
        error: 'æœåŠ¡å™¨é”™è¯¯ï¼Œè¯·ç¨åå†è¯•',
      );
    }
    
    return err;
  }
  
  /// å¤„ç†é»˜è®¤é”™è¯¯
  DioException _handleDefaultError(DioException err) {
    return err.copyWith(
      error: 'å‘ç”ŸæœªçŸ¥é”™è¯¯ï¼Œè¯·ç¨åå†è¯•',
    );
  }
}
```

### 3.4 NetworkManager
```dart
// network_manager.dart
import 'api_service_type.dart';
import 'api_client.dart';
import 'interceptors.dart';
import 'package:dio/dio.dart';

/// ç»Ÿä¸€ç®¡ç†ä¸åŒAPIæœåŠ¡çš„ApiClient
class NetworkManager {
  static final Map<ApiServiceType, ApiClient> _clientMap = {};
  
  /// æ˜¯å¦åœ¨æ‰€æœ‰APIä¸­å¯ç”¨æ—¥å¿—
  static bool enableLog = true;
  
  /// è·å–Tokenå‡½æ•°
  static String Function() tokenGetter = () => '';
  
  /// è·å–æŒ‡å®šç±»å‹çš„ApiClientå®ä¾‹
  static ApiClient getClient(ApiServiceType type) {
    if (!_clientMap.containsKey(type)) {
      _clientMap[type] = _createClient(type);
    }
    return _clientMap[type]!;
  }

  /// æ ¹æ®APIç±»å‹åˆ›å»ºå¯¹åº”çš„ApiClient
  static ApiClient _createClient(ApiServiceType type) {
    // é€šç”¨æ‹¦æˆªå™¨åˆ—è¡¨
    final List<Interceptor> interceptors = [];
    
    // æ·»åŠ é€šç”¨æ‹¦æˆªå™¨
    if (enableLog) {
      interceptors.add(InterceptorFactory.createLogInterceptor());
    }
    
    // æ·»åŠ é”™è¯¯æ‹¦æˆªå™¨
    interceptors.add(InterceptorFactory.createErrorInterceptor());
    
    switch (type) {
      case ApiServiceType.main:
        return ApiClient(
          baseUrl: 'https://api.main.com',
          headers: {'Content-Type': 'application/json'},
          requestTransformer: (data) => data,
          responseTransformer: (data) => data,
          interceptors: [
            ...interceptors,
            // æ·»åŠ é‰´æƒæ‹¦æˆªå™¨
            InterceptorFactory.createAuthInterceptor(tokenGetter),
          ],
        );
      case ApiServiceType.weather:
        return ApiClient(
          baseUrl: 'https://api.weather.com',
          headers: {'Content-Type': 'application/json'},
          requestTransformer: (data) => data,
          responseTransformer: (data) => data,
          interceptors: interceptors,  // ä¸éœ€è¦é‰´æƒ
        );
      case ApiServiceType.auth:
        return ApiClient(
          baseUrl: 'https://api.auth.com',
          headers: {'Content-Type': 'application/json'},
          interceptors: interceptors,  // è®¤è¯æœåŠ¡ä¸€èˆ¬ä¸éœ€è¦é‰´æƒæ‹¦æˆªå™¨
          // è®¤è¯æœåŠ¡å¯èƒ½éœ€è¦æ›´çŸ­çš„è¶…æ—¶æ—¶é—´
          connectTimeout: 10000,
        );
    }
  }
  
  /// è®¾ç½®Tokenè·å–å‡½æ•°
  static void setTokenGetter(String Function() getter) {
    tokenGetter = getter;
  }
  
  /// æ¸…é™¤ApiClientç¼“å­˜
  static void clearClients() {
    _clientMap.clear();
  }
}
```

### 3.5 è¯·æ±‚/å“åº”æŠ½è±¡
```dart
// api_request.dart
/// è¯·æ±‚æŠ½è±¡åŸºç±»ï¼Œæ‰€æœ‰è¯·æ±‚éœ€ç»§æ‰¿æœ¬ç±»
abstract class ApiRequest {
  /// è¯·æ±‚è·¯å¾„
  String get path;
  /// è¯·æ±‚æ–¹æ³•ï¼ˆGET/POSTç­‰ï¼‰
  String get method;
  /// è¯·æ±‚å‚æ•°
  Map<String, dynamic> get params;
}

// api_response.dart
/// å“åº”æŠ½è±¡åŸºç±»ï¼Œæ‰€æœ‰å“åº”éœ€ç»§æ‰¿æœ¬ç±»
abstract class ApiResponse {
  /// é€šè¿‡jsonæ„é€ å“åº”å¯¹è±¡
  ApiResponse.fromJson(Map<String, dynamic> json);
}
```

### 3.6 å…·ä½“è¯·æ±‚/å“åº”æ¨¡å‹
```dart
// user_info_request.dart
import '../network/api_request.dart';

/// è·å–ç”¨æˆ·ä¿¡æ¯è¯·æ±‚
class UserInfoRequest extends ApiRequest {
  @override
  String get path => '/user/info';
  @override
  String get method => 'GET';
  @override
  Map<String, dynamic> get params => {};
}

// user_info_response.dart
import '../network/api_response.dart';

/// ç”¨æˆ·ä¿¡æ¯å“åº”æ¨¡å‹
class UserInfoResponse extends ApiResponse {
  final String name;
  final int age;

  UserInfoResponse({required this.name, required this.age});

  factory UserInfoResponse.fromJson(Map<String, dynamic> json) =>
      UserInfoResponse(
        name: json['name'],
        age: json['age'],
      );
}
```

### 3.7 Service å±‚ç¤ºä¾‹
```dart
// main_service.dart
import '../network/api_service_type.dart';
import '../network/network_manager.dart';

class MainService {
  final ApiClient _client = NetworkManager.getClient(ApiServiceType.main);

  /// è·å–ç”¨æˆ·ä¿¡æ¯
  Future<dynamic> getUserInfo() async {
    final dio = _client.dio;
    final response = await dio.get('/user/info');
    // ä½¿ç”¨è‡ªå®šä¹‰å“åº”è½¬æ¢å™¨
    return _client.responseTransformer?.call(response.data) ?? response.data;
  }
}
```

---

## 4. ä½¿ç”¨ç¤ºä¾‹

### 4.1 åº”ç”¨å¯åŠ¨æ—¶é…ç½®
```dart
void main() {
  // é…ç½®æ˜¯å¦å¯ç”¨æ—¥å¿—
  NetworkManager.enableLog = true;
  
  // é…ç½®è·å–Tokençš„å‡½æ•°
  NetworkManager.setTokenGetter(() {
    // ä»æœ¬åœ°å­˜å‚¨æˆ–å…¶ä»–åœ°æ–¹è·å–Token
    return 'å­˜å‚¨çš„Token';
  });
  
  runApp(MyApp());
}
```

### 4.2 ä½¿ç”¨Serviceå‘é€è¯·æ±‚
```dart
final mainService = MainService();

void fetchUserInfo() async {
  try {
    final userInfo = await mainService.getUserInfo();
    print('è·å–åˆ°ç”¨æˆ·ä¿¡æ¯: $userInfo');
  } catch (e) {
    print('è·å–ç”¨æˆ·ä¿¡æ¯å¤±è´¥: $e');
  }
}
```

---

## 5. ä¼˜ç‚¹æ€»ç»“

- ğŸ±â€ğŸ æ¯ä¸ªAPIæœåŠ¡å¯ç‹¬ç«‹é…ç½®baseUrlã€headersã€æ‹¦æˆªå™¨ã€è½¬æ¢å™¨ï¼Œçµæ´»åº”å¯¹å„ç§éœ€æ±‚ã€‚
- (ï½¡ï½¥Ï‰ï½¥ï½¡)ï¾‰â™¡ å¼ºå¤§çš„æ‹¦æˆªå™¨æœºåˆ¶ï¼Œè½»æ¾å¤„ç†é‰´æƒã€æ—¥å¿—ã€é”™è¯¯ç­‰åœºæ™¯ã€‚
- (à¹‘â€¢Ì€ã…‚â€¢Ì)Ùˆâœ§ ç»“æ„æ¸…æ™°ï¼Œåç»­æ‰©å±•æ›´æ–¹ä¾¿ã€‚
- (ï½¡â€¢ã……â€¢ï½¡)â™¡ ä¾ç„¶æ”¯æŒè¯·æ±‚/å“åº”æŠ½è±¡ï¼Œä¾¿äºç»Ÿä¸€å¤„ç†ã€‚
- (ï¾‰â‰§âˆ€â‰¦)ï¾‰ è¶…æ—¶é…ç½®çµæ´»ï¼Œä¸åŒAPIæœåŠ¡å¯é…ç½®ä¸åŒçš„è¶…æ—¶æ—¶é—´ã€‚

---

å¦‚éœ€æ›´è¯¦ç»†çš„å®ç°æˆ–æœ‰ç‰¹æ®Šéœ€æ±‚ï¼Œæ¬¢è¿éšæ—¶äº¤æµï¼(ã¥ï½¡â—•â€¿â€¿â—•ï½¡)ã¥
