# ğŸ¦„ ç½‘ç»œè¯·æ±‚æ¶æ„è®¾è®¡ï¼ˆå¤šAPIæœåŠ¡ï¼ŒDioå°è£…ï¼ŒApiClientå‡çº§ç‰ˆï¼‰

æœ¬è®¾è®¡é€‚ç”¨äºéœ€è¦å¯¹æ¥å¤šä¸ªä¸åŒç½‘ç«™APIçš„Flutter/Darté¡¹ç›®ï¼Œé‡‡ç”¨Dioè¿›è¡Œç½‘ç»œè¯·æ±‚å°è£…ï¼Œç»“æ„æ¸…æ™°ã€æ˜“æ‰©å±•ã€æ˜“ç»´æŠ¤ã€‚

---

## 1. æ¶æ„æ ¸å¿ƒæ€æƒ³

- **å¤šAPIæœåŠ¡æ”¯æŒ**ï¼šä¸ºä¸åŒAPIæœåŠ¡åˆ›å»ºå•ç‹¬çš„ApiClientã€‚
- **ç»Ÿä¸€å¼‚å¸¸å¤„ç†**ï¼šé€šè¿‡`ApiException`ç»Ÿä¸€å¤„ç†å„ç±»ç½‘ç»œå¼‚å¸¸ã€‚
- **APIæœåŠ¡åˆ†å±‚**ï¼šæ¯ä¸ªAPIæœåŠ¡å•ç‹¬åˆ›å»ºå¯¹åº”ç›®å½•ï¼ŒåŒ…å«clientã€serviceã€modelç­‰ã€‚
- **æ‹¦æˆªå™¨ä¸é€šç”¨é…ç½®**ï¼šå…¨å±€æ‹¦æˆªå™¨ç»Ÿä¸€é…ç½®ï¼Œç‰¹æ®Šéœ€æ±‚å¯å•ç‹¬å¤„ç†ã€‚
- **ç»Ÿä¸€è¯·æ±‚æ¥å£**ï¼šè¯·æ±‚ç»Ÿä¸€é€šè¿‡serviceç±»æ–¹æ³•è°ƒç”¨ï¼Œæ–¹ä¾¿ç®¡ç†å’Œç»´æŠ¤ã€‚
- **è°ƒè¯•æ”¯æŒ**ï¼šé’ˆå¯¹Debugæ¨¡å¼è‡ªåŠ¨æ·»åŠ æ—¥å¿—æ‰“å°å’Œæœ¬åœ°ä»£ç†æŠ“åŒ…åŠŸèƒ½ã€‚

---

## 2. ç›®å½•ç»“æ„å»ºè®®

```
lib/
  core/
    network/
      api_client.dart            // ApiClienté…ç½®åŸºç±»
      api_exception.dart         // å¼‚å¸¸å¤„ç†åŸºç±»åŠå­ç±»
      api/
        qweather/                // å’Œé£å¤©æ°”API
          qweather_api_client.dart   // ä¸“ç”¨å®¢æˆ·ç«¯é…ç½®
          qweather_api_service.dart  // APIæœåŠ¡æ–¹æ³•
          qweather_api_model.dart    // æ•°æ®æ¨¡å‹å®šä¹‰
          qweather_api_model.g.dart  // ç”Ÿæˆçš„åºåˆ—åŒ–ä»£ç 
          qweather_api_model.freezed.dart  // ç”Ÿæˆçš„ä¸å¯å˜ç±»
        other_api/               // å…¶ä»–APIæœåŠ¡
          ...
  config/
    app_config.dart              // åº”ç”¨é…ç½®ï¼ŒåŒ…å«APIå¯†é’¥ã€BaseURLç­‰
```

---

## 3. ä»£ç ç¤ºä¾‹

### 3.1 ApiClient é…ç½®ç±»
```dart
// api_client.dart
import 'dart:io';

import 'package:dio/dio.dart';
import 'package:dio/io.dart';
import 'package:flutter/foundation.dart';

/// APIå®¢æˆ·ç«¯å°è£…äº†APIæœåŠ¡çš„æ‰€æœ‰é…ç½®
class ApiClient {
  final String baseUrl; // åŸºç¡€URL
  final Map<String, String> headers; // è¯·æ±‚å¤´
  final List<Interceptor> interceptors; // æ‹¦æˆªå™¨åˆ—è¡¨
  final int connectTimeout; // è¿æ¥è¶…æ—¶æ—¶é—´ï¼ˆæ¯«ç§’ï¼‰
  final int receiveTimeout; // æ¥æ”¶è¶…æ—¶æ—¶é—´ï¼ˆæ¯«ç§’ï¼‰
  final int sendTimeout; // å‘é€è¶…æ—¶æ—¶é—´ï¼ˆæ¯«ç§’ï¼‰

  ApiClient({
    required this.baseUrl,
    this.headers = const {},
    this.interceptors = const [],
    this.connectTimeout = 15 * Duration.millisecondsPerSecond,
    this.receiveTimeout = 15 * Duration.millisecondsPerSecond,
    this.sendTimeout = 15 * Duration.millisecondsPerSecond,
  });

  /// è·å–é…ç½®å¥½çš„Dioå®ä¾‹
  Dio get dio {
    final dio = Dio(BaseOptions(
      baseUrl: baseUrl,
      headers: headers,
      connectTimeout: Duration(milliseconds: connectTimeout),
      receiveTimeout: Duration(milliseconds: receiveTimeout),
      sendTimeout: Duration(milliseconds: sendTimeout),
    ));
    for (final i in interceptors) {
      dio.interceptors.add(i);
    }
    if (kDebugMode) {
      // å¼€å§‹æ—¶æ·»åŠ æ—¥å¿—æ‰“å°å’ŒæŠ“åŒ…
      dio.interceptors.add(LogInterceptor(
        requestHeader: true,
        requestBody: true,
        responseHeader: true,
        responseBody: true,
        logPrint: (log) {
          print('ğŸŒ HTTP: $log');
        },
      ));
      dio.httpClientAdapter = IOHttpClientAdapter(createHttpClient: () => localProxyHttpClient());
    }
    return dio;
  }
}

/// æœ¬åœ°ä»£ç†æŠ“åŒ…æ‹¦æˆªå™¨
HttpClient localProxyHttpClient() {
  return HttpClient()
    // å°†è¯·æ±‚ä»£ç†åˆ° æœ¬æœºIP:8888ï¼Œæ˜¯æŠ“åŒ…ç”µè„‘çš„IP
    ..findProxy = (uri) {
      return 'PROXY 192.168.102.108:8888';
    }
    // æŠ“åŒ…å·¥å…·ä¸€èˆ¬ä¼šæä¾›ä¸€ä¸ªè‡ªç­¾åçš„è¯ä¹¦ï¼Œè¿™é‡Œéœ€è¦ç¦ç”¨è¯ä¹¦æ ¡éªŒ
    ..badCertificateCallback = (X509Certificate cert, String host, int port) => true;
}
```

### 3.2 å¼‚å¸¸å¤„ç†ç±»
```dart
// api_exception.dart
import 'dart:io';

import 'package:dio/dio.dart';

/// è‡ªå®šä¹‰è¯·æ±‚å¼‚å¸¸çˆ¶ç±»
class ApiException implements Exception {
  final int? code;
  final String? message;
  String? stackInfo;

  ApiException([this.code, this.message]);

  factory ApiException.fromDioException(DioException exception) {
    switch (exception.type) {
      case DioExceptionType.connectionTimeout:
        return BadRequestException(-1, "è¿æ¥è¶…æ—¶");
      case DioExceptionType.sendTimeout:
        return BadRequestException(-1, "è¯·æ±‚è¶…æ—¶");
      case DioExceptionType.receiveTimeout:
        return BadRequestException(-1, "å“åº”è¶…æ—¶");
      case DioExceptionType.cancel:
        return BadRequestException(-1, "è¯·æ±‚å–æ¶ˆ");
      case DioExceptionType.badResponse:
        int? errorCode = exception.response?.statusCode;
        switch (errorCode) {
          case 400:
            return BadRequestException(errorCode, "è¯·æ±‚è¯­æ³•é”™è¯¯");
          case 401:
            return UnauthorisedException(errorCode, "æ²¡æœ‰æƒé™");
          case 403:
            return UnauthorisedException(errorCode, "æœåŠ¡å™¨æ‹’ç»æ‰§è¡Œ");
          case 404:
            return UnauthorisedException(errorCode, "è¯·æ±‚èµ„æºä¸å­˜åœ¨");
          // å…¶ä»–çŠ¶æ€ç å¤„ç†...
          default:
            return ApiException(errorCode, exception.response?.statusMessage ?? 'æœªçŸ¥é”™è¯¯');
        }
      case DioExceptionType.connectionError:
        if (exception.error is SocketException) {
          return DisconnectException(-1, "ç½‘ç»œæœªè¿æ¥");
        } else {
          return ApiException(-1, "è¿æ¥é”™è¯¯");
        }
      // å…¶ä»–å¼‚å¸¸ç±»å‹å¤„ç†...
      default:
        return ApiException(-1, "æœªçŸ¥é”™è¯¯");
    }
  }

  // å°†å„ç§å¼‚å¸¸è½¬æ¢ä¸ºApiExceptionæ–¹ä¾¿è¿›è¡Œç»Ÿä¸€å¤„ç†
  factory ApiException.from(dynamic exception) {
    if (exception is DioException) {
      return ApiException.fromDioException(exception);
    } else if (exception is ApiException) {
      return exception;
    } else {
      return ApiException(-1, "æœªçŸ¥é”™è¯¯")..stackInfo = exception.toString();
    }
  }
}

/// é”™è¯¯è¯·æ±‚å¼‚å¸¸
class BadRequestException extends ApiException {
  BadRequestException(super.code, super.message);
}

/// ç½‘ç»œæœªè¿æ¥å¼‚å¸¸
class DisconnectException extends ApiException {
  DisconnectException(super.code, super.message);
}

/// æœªè®¤è¯å¼‚å¸¸
class UnauthorisedException extends ApiException {
  UnauthorisedException(super.code, super.message);
}
```

### 3.3 ç‰¹å®šAPIå®¢æˆ·ç«¯
```dart
// qweather_api_client.dart
import 'package:dio/dio.dart';
import 'package:precious_life/config/app_config.dart';
import 'package:precious_life/core/network/api_client.dart';

/// å’Œé£å¤©æ°”APIå®¢æˆ·ç«¯
/// è´Ÿè´£å’Œé£å¤©æ°”APIçš„è¯·æ±‚å¤„ç†ï¼Œä½¿ç”¨å•ä¾‹æ¨¡å¼
class QweatherApiClient {
  /// å•ä¾‹
  QweatherApiClient._();
  static final QweatherApiClient _instance = QweatherApiClient._();
  static QweatherApiClient get instance => _instance;

  /// APIå®¢æˆ·ç«¯å®ä¾‹
  late final ApiClient _apiClient = ApiClient(
    baseUrl: AppConfig.qweatherBaseUrl,
    headers: {'Content-Type': 'application/json'},
    interceptors: [
      _QweatherApiInterceptor(),
    ],
  );
  Dio get dio => _apiClient.dio;
}

/// å’Œé£å¤©æ°”APIæ‹¦æˆªå™¨
class _QweatherApiInterceptor extends Interceptor {
  @override
  void onRequest(RequestOptions options, RequestInterceptorHandler handler) {
    /// ä¸ºæ¯ä¸ªè¯·æ±‚æ·»åŠ å¿…è¦çš„å‚æ•°ï¼Œå¦‚APIå¯†é’¥
    options.headers.addAll({
      'X-QW-Api-Key': AppConfig.qweatherApiKey,
    });
    super.onRequest(options, handler);
  }
}
```

### 3.4 APIæœåŠ¡ç±»
```dart
// qweather_api_service.dart
import 'package:precious_life/core/network/api/qweather/qweather_api_client.dart';
import 'package:precious_life/core/network/api/qweather/qweather_api_model.dart';
import '../../api_exception.dart';

/// å’Œé£å¤©æ°”APIæœåŠ¡ç±»
/// æä¾›ä¸€ç³»åˆ—å‘èµ·è¯·æ±‚çš„é™æ€æ–¹æ³•
class QweatherApiService {
  /// åŸå¸‚ä¿¡æ¯æŸ¥è¯¢æ¥å£
  ///
  /// é€šè¿‡åŸå¸‚åç§°æˆ–ç»çº¬åº¦åæ ‡æŸ¥è¯¢åŸå¸‚ä¿¡æ¯
  ///
  /// [location] åŸå¸‚åç§°ã€IDæˆ–ç»çº¬åº¦åæ ‡ï¼Œä¾‹å¦‚ï¼š'æ·±åœ³'ã€'101280604'æˆ–'113.92,22.53'
  static Future<QweatherCityResponse> lookupCity(String location) async {
    try {
      final resp = await QweatherApiClient.instance.dio.get(
        '/geo/v2/city/lookup',
        queryParameters: {'location': location},
      );
      final respJson = resp.data;
      if (respJson['error'] != null) {
        throw ApiException(respJson['error']['status'], respJson['error']['detail']);
      }
      if (respJson['code'] != '200') {
        throw ApiException(respJson['code'], respJson['message']);
      }
      return QweatherCityResponse.fromJson(respJson);
    } catch (e) {
      throw ApiException.from(e);
    }
  }
}
```

---

## 4. ä½¿ç”¨ç¤ºä¾‹

### 4.1 åœ¨åº”ç”¨ä¸­å‘èµ·APIè¯·æ±‚
```dart
import 'package:precious_life/core/network/api/qweather/qweather_api_service.dart';

Future<void> getWeatherInfo() async {
  try {
    // æŸ¥è¯¢åŸå¸‚ä¿¡æ¯
    final cityResponse = await QweatherApiService.lookupCity('æ·±åœ³');
    print('è·å–åˆ°åŸå¸‚ä¿¡æ¯: ${cityResponse.location.first.name}');
    
    // å¯ä»¥ç»§ç»­å‘èµ·å¤©æ°”æŸ¥è¯¢ç­‰
  } catch (e) {
    print('è·å–å¤©æ°”ä¿¡æ¯å¤±è´¥: $e');
  }
}
```

### 4.2 é…ç½®APIå¯†é’¥å’ŒåŸºç¡€URL
```dart
// config/app_config.dart
class AppConfig {
  // å’Œé£å¤©æ°”APIé…ç½®
  static const String qweatherBaseUrl = 'https://api.qweather.com';
  static const String qweatherApiKey = 'your_api_key_here';
  
  // å…¶ä»–APIæœåŠ¡é…ç½®
  // ...
}
```

---

## 5. ä¼˜ç‚¹æ€»ç»“

- ğŸ±â€ğŸ å„APIæœåŠ¡ç‹¬ç«‹å°è£…ï¼Œäº’ä¸å¹²æ‰°ï¼Œæ–¹ä¾¿ç»´æŠ¤å’Œæ‰©å±•ã€‚
- (ï½¡ï½¥Ï‰ï½¥ï½¡)ï¾‰â™¡ ç»Ÿä¸€çš„å¼‚å¸¸å¤„ç†æœºåˆ¶ï¼Œä¾¿äºå…¨å±€é”™è¯¯ç®¡ç†ã€‚
- (à¹‘â€¢Ì€ã…‚â€¢Ì)Ùˆâœ§ Debugæ¨¡å¼è‡ªåŠ¨æ·»åŠ æ—¥å¿—å’ŒæŠ“åŒ…åŠŸèƒ½ï¼Œæ–¹ä¾¿è°ƒè¯•ã€‚
- (ï½¡â€¢ã……â€¢ï½¡)â™¡ å•ä¾‹æ¨¡å¼é¿å…é‡å¤åˆ›å»ºå®¢æˆ·ç«¯å®ä¾‹ï¼Œæé«˜æ€§èƒ½ã€‚
- (ï¾‰â‰§âˆ€â‰¦)ï¾‰ ç»“æ„æ¸…æ™°ï¼ŒèŒè´£åˆ†æ˜ï¼Œæ˜“äºç†è§£å’Œç»´æŠ¤ã€‚
- (ã¥ï½¡â—•â€¿â€¿â—•ï½¡)ã¥ é€‚åˆå¤šäººåä½œå¼€å‘ï¼Œå„è‡ªè´Ÿè´£ä¸åŒAPIæ¨¡å—ã€‚

---

å¦‚éœ€æ›´è¯¦ç»†çš„å®ç°æˆ–æœ‰ç‰¹æ®Šéœ€æ±‚ï¼Œæ¬¢è¿éšæ—¶äº¤æµï¼(ã¥ï½¡â—•â€¿â€¿â—•ï½¡)ã¥
