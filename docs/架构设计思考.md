# 架构设计思考 🏗️

## 🤔 Repository位置设计的思考

### 问题：Repository应该放在哪里？

**选项A：全局Repository** (`lib/data/repositories/`)
**选项B：Feature-specific Repository** (`lib/features/*/data/repositories/`)

## 🎯 混合方案设计

根据数据的**共享程度**和**业务复杂度**来决定Repository的位置：

### 📊 分类规则

#### 🌍 全局Repository (lib/data/repositories/)
**适用于：跨模块共享的核心数据**

```dart
// 这些数据被多个feature使用
lib/data/repositories/
├── weather_repository.dart      # 天气数据：todo、home、dashboard都需要
├── location_repository.dart     # 位置数据：多个模块都需要
├── settings_repository.dart     # 设置数据：全局配置
└── user_repository.dart         # 用户数据：认证、个人信息
```

#### 🏠 Feature-specific Repository (lib/features/*/data/)
**适用于：模块特有的业务数据**

```dart
// 这些数据只在特定模块使用
lib/features/todo/data/repositories/
└── todo_repository.dart         # 待办事项：只有todo模块使用

lib/features/feed/data/repositories/
└── feed_repository.dart         # 信息流：只有feed模块使用

lib/features/tools/data/repositories/
└── tools_repository.dart        # 工具数据：只有tools模块使用
```

## 🔧 具体实施方案

### 第一步：数据分类

**🌍 全局共享数据**：
- ✅ 天气数据 (WeatherRepository) 
- ✅ 位置数据 (LocationRepository)
- ✅ 用户设置 (SettingsRepository)
- ✅ 主题配置 (ThemeRepository)

**🏠 模块特有数据**：
- ✅ 待办事项 (TodoRepository)
- ✅ 信息流内容 (FeedRepository) 
- ✅ 工具集合 (ToolsRepository)

### 第二步：重新组织结构

```
lib/
├── data/                           # 全局共享数据层
│   ├── repositories/               # 跨模块Repository
│   │   ├── weather_repository.dart
│   │   ├── location_repository.dart
│   │   └── settings_repository.dart
│   ├── datasources/                # 共享数据源
│   │   ├── local/
│   │   └── remote/
│   └── models/                     # 共享数据模型
│       ├── weather/
│       └── location/
├── features/
│   ├── todo/
│   │   ├── data/                   # Todo模块专属数据层
│   │   │   ├── repositories/
│   │   │   │   └── todo_repository.dart
│   │   │   ├── datasources/
│   │   │   │   └── todo_local_datasource.dart
│   │   │   └── models/
│   │   │       └── todo.dart
│   │   └── ui/
│   ├── feed/
│   │   ├── data/                   # Feed模块专属数据层
│   │   │   ├── repositories/
│   │   │   │   └── feed_repository.dart
│   │   │   └── models/
│   │   │       └── feed_item.dart
│   │   └── ui/
│   └── tools/
│       ├── data/                   # Tools模块专属数据层
│       │   └── repositories/
│       │       └── tools_repository.dart
│       └── ui/
└── shared/                         # 真正的共享组件
    └── widgets/
```

### 第三步：依赖注入策略

```dart
// lib/data/providers/global_providers.dart
/// 全局共享的Repository Providers
final weatherRepositoryProvider = Provider<WeatherRepository>((ref) {
  return WeatherRepository();
});

final locationRepositoryProvider = Provider<LocationRepository>((ref) {
  return LocationRepository();
});

// lib/features/todo/data/providers/todo_providers.dart
/// Todo模块专属的Repository Providers
final todoRepositoryProvider = Provider<TodoRepository>((ref) {
  // 可能依赖全局的Repository
  final database = ref.read(databaseProvider);
  return TodoRepository(database);
});

// lib/features/feed/data/providers/feed_providers.dart  
/// Feed模块专属的Repository Providers
final feedRepositoryProvider = Provider<FeedRepository>((ref) {
  return FeedRepository();
});
```

## 🎯 判断标准

### 🤝 放到全局Repository的标准：
1. **多模块使用**：至少2个以上feature需要这个数据
2. **核心业务数据**：用户信息、设置、认证等
3. **基础服务数据**：天气、位置、网络状态等
4. **需要共享缓存**：避免重复请求和数据不一致

### 🏠 放到Feature Repository的标准：
1. **单一模块使用**：只有一个feature使用
2. **业务特定逻辑**：与其他模块没有关联
3. **复杂业务规则**：需要特定的业务逻辑处理
4. **独立生命周期**：可以独立开发和测试

## 💡 实际应用建议

### 对于你的项目：

**立即迁移到Feature-specific**：
- ✅ `TodoRepository` → `lib/features/todo/data/repositories/`
- ✅ `FeedRepository` → `lib/features/feed/data/repositories/`

**保持全局共享**：
- ✅ `WeatherRepository` → `lib/data/repositories/` (todo和home都用)
- ✅ `LocationRepository` → `lib/data/repositories/` (多个模块都用)
- ✅ `SettingsRepository` → `lib/data/repositories/` (全局配置)

### 迁移好处：
1. **更清晰的模块边界**
2. **更好的代码组织**
3. **更容易的单元测试**
4. **更强的团队协作能力**

## 🎉 总结

这种混合方案兼顾了：
- **共享数据的一致性** (全局Repository)
- **模块的独立性** (Feature Repository)
- **代码的可维护性** (合理的职责分离)

选择Repository位置的核心原则是：**根据数据的使用范围和业务复杂度来决定**！ ⭐ 